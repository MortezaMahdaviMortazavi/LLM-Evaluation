from abc import ABC, abstractmethod
from textwrap import dedent
from typing import ClassVar

class SummarizationBasePrompt(ABC):
    """
    Abstract base class for all prompts. Defines the common interface and behavior.
    """

    system_prompt: ClassVar[str]
    user_prompt: ClassVar[str]

    COT_REASONS_TEMPLATE: ClassVar[str] = """
        Please answer using the entire template below.

        TEMPLATE:
        Score: <The score based on the given criteria>
    """.strip()

    @abstractmethod
    def generate_prompt(self, context: str, reference_summary: str, summary: str) -> str:
        """
        Generate the complete prompt to be fed into the model.

        :param context: The source context text.
        :param reference_summary: The reference summary to compare against.
        :param summary: The summary generated by the model.
        :return: The complete prompt string.
        """
        pass

class ComprehensivenessPrompt(SummarizationBasePrompt):
    """
    Evaluator for assessing the comprehensiveness of model-generated summaries based on the given context.
    """

    system_prompt: ClassVar[str] = dedent(
        """
        You are tasked with evaluating summarization quality. Please follow the instructions below.

        INSTRUCTIONS:

        1. Evaluate the model-generated summary based on the provided context.
        2. Assess how comprehensively the model's summary covers the key points and important details presented in the context.

        Scoring criteria:
        0 - The model's summary misses most of the key points and important details from the context.
        5 - The model's summary includes some key points and important details, but is missing others, or the information is only vaguely covered.
        10 - The model's summary comprehensively covers all the key points and important details from the context.
        """
    )

    user_prompt: ClassVar[str] = dedent(
        """
        /CONTEXT/
        {context}
        /END OF CONTEXT/

        /MODEL SUMMARY/
        {summary}
        /END OF MODEL SUMMARY/

        TEMPLATE:
        Score: <The score from 0 (the summary misses most key information) to 10 (the summary covers all key information comprehensively).>
        """
    )
    
    @staticmethod
    def generate_prompt(context: str, summary: str) -> str:
        """
        Generate the complete prompt by combining the system instructions and the user prompt.

        :param context: The source context text.
        :param summary: The summary generated by the model.
        :return: The complete prompt string.
        """
        return SummarizationBasePrompt.COT_REASONS_TEMPLATE + "\n\n" + ComprehensivenessPrompt.system_prompt.strip() + "\n\n" + ComprehensivenessPrompt.user_prompt.format(context=context.strip(), summary=summary.strip()).strip()



if __name__ == "__main__":
    context = """
        The Amazon rainforest, often referred to as the "lungs of the Earth," plays a crucial role in regulating the planet's climate. Spanning over 5.5 million square kilometers, it is home to an estimated 400 billion individual trees, comprising around 16,000 different species. This vast expanse of forest is not only a carbon sink, absorbing millions of tons of CO2 annually, but also a biodiversity hotspot, housing approximately 10% of all known species on Earth. However, the Amazon is under severe threat due to deforestation, driven primarily by logging, agriculture, and mining activities. In recent years, deforestation rates have surged, with nearly 10,000 square kilometers of forest being cleared annually. This rampant deforestation not only threatens wildlife but also exacerbates climate change by releasing stored carbon into the atmosphere. Furthermore, the loss of trees disrupts the water cycle, leading to reduced rainfall, which in turn affects agriculture and water supplies across South America. To mitigate these impacts, there have been international efforts to protect and restore the Amazon, including initiatives like REDD+ (Reducing Emissions from Deforestation and Forest Degradation) and various reforestation projects. Despite these efforts, challenges remain, as enforcement of environmental laws is often weak, and economic pressures continue to drive deforestation.
    """
    reference_summary = """
        The Amazon rainforest, crucial for climate regulation and biodiversity, is being severely threatened by deforestation due to logging, agriculture, and mining. This deforestation, which has been increasing in recent years, not only endangers wildlife but also contributes to climate change by releasing stored carbon and disrupting the water cycle. International efforts like REDD+ aim to protect and restore the forest, but challenges such as weak law enforcement and economic pressures persist.
    """
    summary = """
        The Amazon rainforest is big and has a lot of trees. Deforestation is happening, which is bad for the environment. There are some efforts to stop it, but itâ€™s hard.
    """
    prompt = ComprehensivenessPrompt.generate_prompt(context=context,reference_summary=reference_summary,summary=summary)
    print(prompt)